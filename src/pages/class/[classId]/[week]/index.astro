---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { agendasConfig, getClassById } from '../../../../lib/agendas';
import {
  academicWeekNumber,
  displayWeekLabel,
  initAcademicMeta,
  isSkipWeek,
  mergedWeeks,
} from '../../../../lib/academic';
import {
  formatDateRange,
  getWeekRange,
  isoWeekKey,
  normalizeWeekKey,
  parseWeekKey,
} from '../../../../lib/week';

import weeklyScriptUrl from '../../../../scripts/weekly.ts?url';

const meta = initAcademicMeta(agendasConfig);

export function getStaticPaths() {
  const meta = initAcademicMeta(agendasConfig);
  return agendasConfig.classes.flatMap((cls) => {
    const weeks = mergedWeeks(meta, cls);

    return weeks.flatMap((wk) => {
      const parsed = parseWeekKey(wk);
      const aliases = new Set<string>([wk]);

      // Back-compat: allow /2026-W2/ in addition to /2026-W02/
      if (parsed && parsed.isoWeek < 10) {
        aliases.add(`${parsed.isoYear}-W${parsed.isoWeek}`);
      }

      return [...aliases].map((week) => ({
        params: { classId: cls.id, week },
      }));
    });
  });
}

const { classId, week: weekParam } = Astro.params;
const cls = classId ? getClassById(agendasConfig, classId) : null;

const weekKey = weekParam ? normalizeWeekKey(weekParam) || weekParam : null;

const weeks = cls ? mergedWeeks(meta, cls) : [];
const isBreak = weekKey ? isSkipWeek(meta, weekKey) : false;

const slideId = cls && weekKey && !isBreak ? cls.weeks[weekKey] || null : null;

const weeklyDataJson = JSON.stringify({
  classId,
  weekKey,
  weekKeyParam: weekParam,
  slideId,
  isSkipWeek: isBreak,
});

const idx = weekKey ? weeks.indexOf(weekKey) : -1;
const prevWeek = idx > 0 ? weeks[idx - 1] : null;
const nextWeek = idx !== -1 && idx < weeks.length - 1 ? weeks[idx + 1] : null;

const range = weekKey ? getWeekRange(weekKey) : null;
const dateRange = range ? formatDateRange(range.start, range.end) : 'â€”';

const aw = weekKey ? academicWeekNumber(meta, weekKey) : null;
const activeLabel = isBreak
  ? 'Break'
  : aw
    ? `Week ${aw}`
    : weekKey
      ? `Week: ${weekKey}`
      : 'Week: â€”';

const currentWeekKey = isoWeekKey(new Date());

const overlayMessage = !cls
  ? 'Class not found.'
  : !weekKey
    ? 'Week not found.'
    : isBreak
      ? 'Break week â€” no class sessions.'
      : !slideId
        ? 'Slides not available for selected week.'
        : '';
---

<BaseLayout title={cls ? `${cls.name} Â· ${activeLabel}` : 'Launch Slides'}>
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <details class="class-dropdown">
          <summary class="class-summary">
            <span class="class-name">{cls?.name || 'Select Class'}</span>
            <span class="dropdown-arrow">â–¾</span>
          </summary>
          <div class="class-menu">
            {agendasConfig.classes.map((c) => (
              <a
                class={`class-item${c.id === classId ? ' active' : ''}`}
                href={`/class/${c.id}/`}
              >
                {c.name}
              </a>
            ))}
          </div>
        </details>
      </div>

      <nav class="week-nav" aria-label="Week navigation">
        <div class="week-scroll">
          {weeks.map((wk) => {
            const isCurrent = wk === currentWeekKey;
            const isActive = wk === weekKey;
            const isBreakWk = isSkipWeek(meta, wk);
            const n = academicWeekNumber(meta, wk);

            const className = `week-chip${isCurrent ? ' current' : ''}${isActive ? ' active' : ''}${
              isBreakWk ? ' break' : ''
            }`;

            return (
              <a class={className} href={`/class/${classId}/${wk}/`}>
                {isBreakWk ? 'Break' : n ? `W${n}` : wk}
              </a>
            );
          })}
        </div>
      </nav>

      <div class="topbar-right">
        <button
          id="copyLinkBtn"
          class="icon-btn"
          type="button"
          title="Copy link"
        >
          ðŸ”—
        </button>
        <button
          id="toggleFullBtn"
          class="icon-btn"
          type="button"
          aria-pressed="false"
          title="Toggle fullscreen"
        >
          â›¶
        </button>
        <details class="options-dropdown">
          <summary class="icon-btn" title="Options">â‹¯</summary>
          <div class="options-panel">
            <div class="options-grid">
              <div class="sub-control">
                <div class="tag small">{activeLabel}</div>
              </div>
              <div class="sub-control">
                <div class="tag small">Dates: {dateRange}</div>
              </div>
              <div class="sub-control">
                <a
                  id="openInNewTab"
                  class="btn-inline"
                  href={slideId ? `https://docs.google.com/presentation/d/${encodeURIComponent(slideId)}/edit?usp=sharing` : undefined}
                  target="_blank"
                  rel="noopener"
                  aria-disabled={!slideId}
                  tabindex={slideId ? undefined : -1}
                >
                  Open in Tab
                </a>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>
  </header>

  <main>
    <div class="viewer-container">
      <div id="messageOverlay" role="alert" style={overlayMessage ? 'display:flex' : 'display:none'}>
        {overlayMessage}
      </div>
      <iframe
        id="slidesFrame"
        class="viewer"
        title="Google Slides agenda"
        allowfullscreen
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>

      <div class="fullscreen-class-switch">
        {(() => {
          const CLASS_ORDER = [
            'cs-1-pathway',
            'cs-3',
            'cs-4',
            'cs-2',
            'mythology',
            'cs-1-semester',
          ];
          return CLASS_ORDER.map((id, idx) => {
            const cls = agendasConfig.classes.find((c) => c.id === id);
            if (!cls) return null;
            return (
              <a href={`/class/${cls.id}/?fullscreen=true`} title={`${idx + 1} - ${cls.name}`}>
                {idx + 1}
              </a>
            );
          });
        })()}
      </div>

      <div id="keyboardCapture" class="keyboard-capture"></div>

      <button id="exitFullscreenBtn" class="icon-btn exit-btn" type="button" aria-label="Exit fullscreen">
        â›¶ Exit
      </button>
    </div>
  </main>

<div id="weekly-data" data-class-id={classId} data-week-key={weekKey} data-week-key-param={weekParam} data-slide-id={slideId} data-is-skip-week={isBreak ? 'true' : 'false'}></div>
  <script type="module" src={weeklyScriptUrl}></script>
</BaseLayout>
